
<!DOCTYPE html>
<html>
<h1> slotmachinetest 1.</h1>
<p>
    Sample snare03 wordt 3 herhaald groep zestiende noten.
    Werkt  13 juni 22:12
    2. speelt ritme van 4 tellen 1 = sinaasappel 2 appel 3 peer 4 appel
    3. met gain en normaliseerde sample
    4 volume variatie met gain.gain.value = (accent/10);
    5. volume control naar 100 en transpose weer ingevoerd. sample met reverb gated drum 10ms
    6 BPM 72
</p>

<input id="t1"/>
<input id="t2"/>
<input id="t3"/>
<input id="t4"/>
<br/>

<button onclick="playAll()">Play All</button>
<button onclick="playRitme()">Play ritme</button>
<button onclick="playDrum()">Play drumloop</button>
<script>


    var config = {
        introRitme: [
            [
                {
                    time: 0,
                    gain: 50,
                    transpose: 8
                }
            ],
            [
                {
                    time: 0,
                    gain: 50,
                    transpose: 8
                }
            ],
            [
                {
                    time: 0,
                    gain: 50,
                    transpose: 8
                }
            ],
            [
                {
                    time: 0,
                    gain: 50,
                    transpose: 8
                }
            ]
        ],
        ritmes: [
            [
            ],
            [
                {
                    time: 0,
                    gain: 100,
                    transpose: 10
                }
            ],
            [
                {
                    time: 0,
                    gain: 100,
                    transpose: 10
                },
                {
                    time: 2,
                    gain: 100,
                    transpose: 10
                }
            ],
            [
                {
                    time: 0,
                    gain: 100,
                    transpose: 10
                },
                {
                    time: 1,
                    gain: 80,
                    transpose: 10
                },
                {
                    time: 2,
                    gain: 85,
                    transpose: 10
                },
                {
                    time: 3,
                    gain: 70,
                    transpose: 10
                }
            ]
        ],
        bpm: 72
    }


    function readInputValues() {
        var t1 = 1 * document.getElementById('t1').value
        var t2 = 1 * document.getElementById('t2').value
        var t3 = 1 * document.getElementById('t3').value
        var t4 = 1 * document.getElementById('t4').value

        var result = [t1, t2, t3, t4]
        return result
    }


    function playAll() {

        var ritmeToPlay = readInputValues()
        console.log(ritmeToPlay)

        playRitme2(ritmeToPlay, true)
    }


    function playRitme() {

        //var ritmeToPlay = [3,3,3,3]
        var ritmeToPlay = readInputValues()

        playRitme2(ritmeToPlay)
    }


    function playDrum() {
        startTime = audioContext.currentTime
        play(bufferDrum, 0, 70, 0)
    }





    function playRitme2(ritme, withDrums) {
        console.log('speel: ', ritme)

        let ritmeToPlay = []
                // = config.introRitme

        config.introRitme.forEach(function(value) {
            ritmeToPlay.push(value)
        })


        ritme.forEach(function(value) {
            console.log (value)
            ritmeToPlay.push(config.ritmes[value])
        })

        console.log(ritmeToPlay)

        startTime = audioContext.currentTime


        if (withDrums) {
            play(bufferDrum, 0, 70, 0)
        }

        let counter = 0
        ritmeToPlay.forEach(function (beat) {
            playBeat(counter++, beat)
        })


    }


    function playBeat(delay, beat) {
        // console.log(delay, beat)
        beat.forEach(function(attack) {
            // console.log(delay, kwart)
            var beatTime = (60 / config.bpm)
            var startTime = delay * beatTime + attack.time * beatTime/ 4

            // console.log(startTime)
            play(bufferSnare, startTime, attack.gain, attack.transpose)
        })
    }



    var audioContext = new AudioContext()
    var bufferSnare
    var bufferDrum

    function getSample (url, cb) {
        var request = new XMLHttpRequest()
        request.open('GET', url)
        request.responseType = 'arraybuffer'
        request.onload = function () {
            audioContext.decodeAudioData(request.response, cb)
        }
        request.send()
    }


    function play (sound, delay, accent,transpose) {
        var player = audioContext.createBufferSource()
        var gain = audioContext.createGain()
        player.buffer = sound
        player.connect(gain)

        gain.gain.value = (accent/100);
        gain.connect(audioContext.destination);
        player.start(startTime + delay)
        if (transpose !== 0) {
            player.playbackRate.value = Math.pow(2,transpose/12)
        }
    }

    getSample('/Snare04r.mp3', function (_buffer) {
        console.log('geluid geladen')
        bufferSnare = _buffer
    })

    getSample('/Drumloop01.mp3', function (_buffer) {
        console.log('geluid geladen')
        bufferDrum = _buffer
    })

</script>
</html>